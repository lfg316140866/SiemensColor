Cmn_UI_AutoComplete_Version = "2.3", function (a) { a || a.alert("为引用Cmn"), a.UI || (a.UI = {}); var b = function (b, c) { function k(b) { function c(a) { var b = $(a).parent(); return "absolute" == b.css("position") || "relative" == b.css("position") || "htmlbodyelement" == Cmn.IsType(b[0]) ? b.offset() : c(b) } Cmn.IsType(b, "array") && b.length ? (g.empty().hide(), $.each(b, function (b, c) { var i, e = h.eq(0).clone(!0, !0), f = e.find(d.Selector.Text).length > 0 ? e.find(d.Selector.Text) : e; a.Object.IsType(c, "object") ? (i = 0, $.each(c, function (a, b) { 0 == i ? e.attr("cmn-AutoComplete-Value", b) : 1 == i && f.text(b), i++ }), e.data(c), g.append(e)) : Cmn.DebugLog("数据格式不合法") }), "auto" == g.attr("auto") && g.css({ width: e.outerWidth() - 2, top: e.offset().top - c(g).top + e.outerHeight(), left: e.offset().left - c(g).left }), g.show().data(e), g.css({ height: g.children().eq(0).outerHeight() * (b.length > 10 ? 10 : b.length) })) : l() } function l() { g.hide() } function m(b) { /[\S]+/.test((a.Object.IsType(b, "string") ? b : "").trim()) ? CmnAjax.PostData(c, d.SerializeParam("*" == b ? "" : b), function (a) { a = d.FormatData(a), d.OnDataLoadComplete.Trigger([a]), k(a) }) : l() } function n() { f.find(d.Selector.OptionPanel + "[auto=auto]").length <= 0 ? (g = $("<div auto='auto' class='" + Cmn.Str.GetSelectorName(d.Selector.OptionPanel) + "'>"), h = $("<div class='" + Cmn.Str.GetSelectorName(d.Selector.Item) + "'>"), i = $("<span class='" + Cmn.Str.GetSelectorName(d.Selector.Text) + "'>"), g.append(h), h.append(i), f.append(g), g.css({ border: "1px #ccc solid", "z-index": "999", overflow: " auto", position: "absolute", display: "none", background: "#fff" }), h.css({ padding: "8px", cursor: "pointer" }), $("head").append($("<style>.Cmn-AutoComplete-Item:hover{background:#ccc;color:#fff;}.Cmn-AutoComplete-ItemHover{background:#ccc;color:#fff;}</style>"))) : (g = f.find(d.Selector.OptionPanel + "[auto=auto]"), h = g.find(d.Selector.Item), i = g.find(d.Selector.Text)) } function o(b) { var c = $(this).val(); switch (b.keyCode) { case a.UI.KeyCode.HOME: break; case a.UI.KeyCode.END: break; case a.UI.KeyCode.UP: break; case a.UI.KeyCode.DOWN: break; case a.UI.KeyCode.LEFT: break; case a.UI.KeyCode.RIGHT: break; case a.UI.KeyCode.ENTER: break; case a.UI.KeyCode.SPACE: m(c); break; case a.UI.KeyCode.BACKSPACE: m(c); break; case a.UI.KeyCode.ESCAPE: break; default: m(c) } a.UI.StopBubble(b), a.UI.StopDefault(b) } function p(b) { switch (b.keyCode) { case a.UI.KeyCode.HOME: break; case a.UI.KeyCode.END: break; case a.UI.KeyCode.UP: a.UI.StopDefault(b); break; case a.UI.KeyCode.DOWN: a.UI.StopDefault(b); break; case a.UI.KeyCode.LEFT: break; case a.UI.KeyCode.RIGHT: break; case a.UI.KeyCode.ENTER: case a.UI.KeyCode.SPACE: break; case a.UI.KeyCode.BACKSPACE: break; case a.UI.KeyCode.ESCAPE: } } var j, d = this, e = null, f = null, g = null, h = null, i = null; this.Limit = 15, this.Selector = { Input: ".Cmn-AutoComplete-Input", OptionPanel: ".Cmn-AutoComplete-OptionPanel", Item: ".Cmn-AutoComplete-Item", Text: ".Cmn-AutoComplete-Text", ItemSelect: ".Cg-AutoComplete-ItemHover" }, this.OnChange = new Cmn.Event(this), this.OnFocus = new Cmn.Event(this), this.OnBlur = new Cmn.Event(this), this.OnDataLoadComplete = new Cmn.Event(this), this.OnSelect = new Cmn.Event(this), this.FormatData = function (b) { return b && a.Object.IsType(b, "string") && (b = $.parseJSON(b)), b && b.data && (b = a.Object.IsType(b.data, "string") ? $.parseJSON(b.data) : b.data), b || [] }, this.SerializeParam = function (a) { return { param: a, Limit: this.Limit, DisplayFieldCount: 2 } }, this.SetValue = function (a) { var c, f, h, b = e; return g && (b = g.data()[0] ? g.data() : e), Cmn.IsType(a, "array") && (a = a[0]), Cmn.IsType(a, "object") && (Cmn.IsType(a.data, "array") && (a = a.data[0]), Cmn.IsType(a, "object")) ? (c = 0, f = e.attr("cmn-AutoComplete-Value"), h = [], $.each(a, function (a, d) { 0 == c ? (b.attr("cmn-AutoComplete-Value", d), h.push(d)) : 1 == c && (b.val(d), h.push(d)), c++ }), h.push(a), h[0] != f && d.OnChange.Trigger(h), b.attr("cmn-AutoComplete-Value", h[0]), b.val(h[1]), 0 != d.OnSelect.Trigger(h) && l(), !1) : (b.attr("cmn-AutoComplete-Value", ""), b.val(""), void 0) }, this.GetValue = function () { return e.attr("cmn-AutoComplete-Value") }, this.GetText = function () { return e.val() }, this.AppendTo = function (b) { f = $(b), n(), $(g).on(a.UI.EventType.Mousedown, function (b) { a.UI.StopDefault(b), Cmn.Func.IsIE() && e.off("blur", j) }), $(g).on(a.UI.EventType.Mouseup, function (b) { a.UI.StopDefault(b), Cmn.Func.IsIE() && e.off("blur").on("blur", j) }), $(g).undelegate(a.UI.EventType.Mousedown).delegate(d.Selector.Item, a.UI.EventType.Mousedown, function (b) { b = b || window.event, 3 != b.which && (d.SetValue($(this).data()), a.UI.StopBubble(b)) }) }, Cmn.IsType($(b)[0], "htmlinputelement") ? (e = $(b), d.AppendTo("body")) : (e = $(b).find(d.Selector.Input), f = $(b)), e.off("keyup").on("keyup", o), e.off("keydown").on("keydown", p), j = function () { d.OnBlur.Trigger(), l() }, e.off("blur").on("blur", j), e.off("focus").on("focus", function () { d.OnFocus.Trigger(); var a = "" == $.trim(e.val()) ? "*" : e.val(); m(a) }), $(g).on(a.UI.EventType.Mousedown, function (b) { a.UI.StopDefault(b), Cmn.Func.IsIE() && e.off("blur", j) }), $(g).on(a.UI.EventType.Mouseup, function (b) { a.UI.StopDefault(b), Cmn.Func.IsIE() && e.off("blur").on("blur", j) }), $(g).undelegate(a.UI.EventType.Mousedown).delegate(d.Selector.Item, a.UI.EventType.Mousedown, function (b) { b = b || window.event, 3 != b.which && (d.SetValue($(this).data()), a.UI.StopBubble(b)) }) }; a.UI.AutoComplete = function (a, c) { return new b(a, c) } }(Cmn);