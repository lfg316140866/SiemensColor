Cmn_UI_CanvasTools_PictureEditing_Version = "1.0", function (a) { var c = {}, d = function (b, d, e, f) { var i, j, k, l, g = this, h = Cmn.Object.IsType($(b)[0], "HTMLCanvasElement") ? $(b)[0] : $(b).append(document.createElement("canvas")).find("canvas")[0]; d && e || Cmn.alert("PictureEditing.js : 实例图片编辑对象的时候发生错误，舞台的宽高是必须要传入的!"), g.Width = 1 * d, g.Height = 1 * e, $(h).attr("width", d), $(h).attr("height", e), g.EditCfg = Cmn.Extend({ MinScale: 0, MaxScale: 10, ScaleStep: .05 }, f), g.Stage = new createjs.Stage(h), g.Root = new createjs.Container, g.Root.name = "Root", g.Stage.addChild(g.Root), g.BgContainer = new createjs.Container, g.BgContainer.name = "BgContainer", g.Root.addChild(g.BgContainer), g.MainContainer = new createjs.Container, g.MainContainer.name = "MainContainer", g.Root.addChild(g.MainContainer), g.FilterContainer = new createjs.Container, g.FilterContainer.name = "FilterContainer", g.Root.addChild(g.FilterContainer), g.ModelContainer = new createjs.Container, g.ModelContainer.name = "ModelContainer", g.Root.addChild(g.ModelContainer), g.StickersContainer = new createjs.Container, g.StickersContainer.name = "StickersContainer", g.Root.addChild(g.StickersContainer), g.Stage.enableMouseOver(20), createjs.Touch.enable(g.Stage), createjs.Ticker.setFPS(65), createjs.Ticker.addEventListener("tick", function () { g.Stage.update() }), g.CurActionState = "LockUserActionStickers", i = g.CurActionState, g.LockUserAction = function () { "LockUserAction" != g.CurActionState && (i = g.CurActionState, g.CurActionState = "LockUserAction", l = null, j()) }, g.LockUserActionImage = function () { g.CurActionState = "LockUserActionImage", l = null, j() }, g.LockUserActionStickers = function () { g.CurActionState = "LockUserActionStickers", l = null, j() }, g.UnLockUserAction = function () { g.CurActionState = i }, g.GetCanvas = function () { return h }, g.SetImage = function (a) { function e() { if (!(++c >= 2)) { d.x = (g.Width - b.width) / 2, d.y = (g.Height - b.height) / 2; var a = new createjs.Bitmap(b); a.regX = b.width / 2, a.regY = b.height / 2, a.x = b.width / 2, a.y = b.height / 2, d.addChild(new createjs.Shape), d.addChild(a) } } var d, b = null, c = 0; Cmn.IsType(a, "string") ? (b = new Image, b.onload = e, b.src = a) : b = a, d = new createjs.Container, g.MainContainer.removeAllChildren(), g.MainContainer.addChild(d), b.complete && e() }, g.RemoveImage = function () { g.MainContainer.removeAllChildren() }, g.SetFilterEffect = function (a) { var b = c[a], d = g.MainContainer.children[0]; Cmn.IsType(b, "function") && d ? (g.RemoveFilterEffect(), b.call(d.children[1], g)) : Cmn.alert("滤镜不存在或者滤镜应用的图片对象不存在！是否没有添加图片") }, g.RemoveFilterEffect = function () { var a = g.MainContainer.children[0]; a.children[1] && (a.children[1].filters = [], a.children[1].uncache()), g.FilterContainer.removeAllChildren(), _IsSetFilterEffect = !1 }, g.SetModel = function (a) { function d() { if (!(++c >= 2)) { var a = new createjs.Bitmap(b), d = 1; d = g.Width / b.width > g.Height / b.height ? g.Width / b.width : g.Height / b.height, a.scaleX = d, a.scaleY = d, a.x = (g.Width - b.width * d) / 2, a.y = (g.Height - b.height * d) / 2, g.ModelContainer.removeAllChildren(), g.ModelContainer.addChild(a) } } var b = null, c = 0; Cmn.IsType(a, "string") ? (b = new Image, b.onload = d, b.src = a) : b = a, b.complete && d() }, g.RemoveModel = function () { g.ModelContainer.removeAllChildren() }, j = function () { for (var a = 0; a < g.StickersContainer.children.length; a++) g.StickersContainer.children[a].dispatchEvent("blur"), g.StickersContainer.children[a].IsFocus = !1 }, g.AddStickers = function (a, b) { function e() { var a, e, f; ++d >= 2 || (a = new createjs.Container(a), e = new createjs.Bitmap(c), f = new createjs.Shape, f.visible = !1, f.graphics.beginFill("rgba(0, 0, 0, 0.8)").drawCircle(c.width - 10, -20, 15), f.graphics.beginStroke("#fff"), f.graphics.setStrokeStyle(3), f.graphics.moveTo(c.width - 2, -27), f.graphics.lineTo(c.width - 17, -15), f.graphics.moveTo(c.width - 17, -27), f.graphics.lineTo(c.width - 2, -15), a.addChild(f), a.addChild(e), e.regX = c.width / 2, e.regY = c.height / 2, e.x = e.regX, e.y = e.regY, a.x = (g.Width - c.width) / 2, a.y = (g.Height - c.height) / 2, 2 == arguments.length ? g.StickersContainer.addChildAt(a, b) : g.StickersContainer.addChild(a), f.addEventListener("mousedown", function () { g.StickersContainer.removeChild(a) }), e.addEventListener("mousedown", function () { e.dispatchEvent("mouseover"), l = a }), e.addEventListener("mouseover", function () { a.IsFocus || "LockUserActionImage" != g.CurActionState || (a.dispatchEvent("focus"), a.IsFocus = !0); for (var c = 0; c < g.StickersContainer.children.length; c++) g.StickersContainer.children[c].IsFocus && g.StickersContainer.children[c].id != a.id && (g.StickersContainer.children[c].dispatchEvent("blur"), g.StickersContainer.children[c].IsFocus = !1) }), a.addEventListener("blur", function () { a.children[0].visible = !1 }), a.addEventListener("focus", function () { a.children[0].visible = !0 }), a.addEventListener("resize", function () { var b = (e.image.width * e.scaleX - e.image.width) / 2, c = (e.image.height * e.scaleX - e.image.height) / 2; f.x = b, f.y = -1 * c })) } var c = null, d = 0; Cmn.IsType(a, "string") ? (c = new Image, c.onload = e, c.src = a) : c = a, c.complete && e() }, g.RemoveStickers = function (a) { 0 == arguments.length ? g.StickersContainer.removeAllChildren() : g.StickersContainer.removeChildAt(a) }, g.ExtendFilter = function () { }, g.GetImageToBase64 = function () { return j(), g.Stage.cache(0, 0, g.Width, g.Height), g.Stage.cacheCanvas.toDataURL("image/png") }, k = { X: 0, Y: 0, ScaleX: 1, ScaleY: 1, Rotation: 0 }, l = null, $(h).on("DOMMouseScroll mousewheel", function (a) { if (a.preventDefault(), a = a.originalEvent, "LockUserAction" == g.CurActionState ? l = null : "LockUserActionStickers" == g.CurActionState && (l = g.MainContainer.children[0]), l) { var b = -1 * (a.wheelDelta ? a.wheelDelta / -120 : (a.detail || 0) / 3) * Math.abs(g.EditCfg.ScaleStep); if (!(k.ScaleX - g.EditCfg.ScaleStep > g.EditCfg.MinScale && k.ScaleY - g.EditCfg.ScaleStep > g.EditCfg.MinScale && 0 > b || k.ScaleX + g.EditCfg.ScaleStep < g.EditCfg.MaxScale && k.ScaleY + g.EditCfg.ScaleStep < g.EditCfg.MaxScale && b > 0)) return !1; k.ScaleX += b, k.ScaleY += b, l.children[1].scaleX = k.ScaleX, l.children[1].scaleY = k.ScaleY, l.dispatchEvent("resize"), l.children[1].cacheID > 0 && l.children[1].updateCache() } }), a.touch && touch.on(h, "dragstart drag pinchstart pinch rotate", function (a) { if ("LockUserAction" == g.CurActionState ? l = null : "LockUserActionStickers" == g.CurActionState && (l = g.MainContainer.children[0]), l) if ("dragstart" == a.type) k.X = l.x, k.Y = l.y; else if ("drag" == a.type) l.x = k.X + a.x, l.y = k.Y + a.y; else if ("pinchstart" == a.type) k.ScaleX = l.children[1].scaleX, k.ScaleY = l.children[1].scaleY, k.Rotation = l.children[1].rotation; else if ("rotate" == a.type) l.children[1].rotation = k.Rotation + a.rotation, l.children[1].cacheID > 0 && l.children[1].updateCache(); else if ("pinch" == a.type) { var b = a.scale - 1; if (!(k.ScaleX + b - g.EditCfg.ScaleStep > g.EditCfg.MinScale && k.ScaleY + b - g.EditCfg.ScaleStep > g.EditCfg.MinScale && 0 > b || k.ScaleX + b + g.EditCfg.ScaleStep < g.EditCfg.MaxScale && k.ScaleY + b + g.EditCfg.ScaleStep < g.EditCfg.MaxScale && b > 0)) return !1; l.children[1].scaleX = k.ScaleX + b, l.children[1].scaleY = k.ScaleY + b, l.dispatchEvent("resize"), l.children[1].cacheID > 0 && l.children[1].updateCache() } }) }; Cmn.UI || (Cmn.UI = {}), Cmn.UI.CanvasTools || (Cmn.UI.CanvasTools = {}), Cmn.UI.CanvasTools.ImageEditing = function (a, b, c, e) { return new d(a, b, c, e) }, Cmn.UI.CanvasTools.ImageEditing.ExtendFilterEffects = function (a, b) { c[a] = b } }(window);