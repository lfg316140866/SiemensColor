CmnMisEditPanelLayout_Version = "2.0", function () { function c(a, c) { var e = $(a).find(CmnMis.UI.Control.Selector.Container), f = e.not(e.find(CmnMis.Frame.Cfg.Selector.UserFormTemplate).find(CmnMis.UI.Control.Selector.Container)), g = 0, h = f.length; f.each(function () { var a = CmnMis.UI.Control.GetControl($(this)); void 0 != a && null != a ? a.ControlDom.attr("edit") ? (a.ControlDom.attr("edit", ""), function (a) { CmnAjax.PostData(InterfaceUrl + "?method=UpdateRec", a, function () { ++g >= h - 1 && c && c() }) }({ CurUserFormID: b, RecID: d(CmnMis.CurUserForm.UserFormID, a.KeyName), controlcfg: Cmn.Func.JsonToStr(a.ControlCfg) })) : ++g >= h - 1 && c && c() : Cmn.Log("在获取值列表的时候，没有找到对应的控件对象。控件名：" + a.KeyName) }) } function d(c, d) { if (a[d]) return a[d]; var e = CmnAjax.GetData(InterfaceUrl + "?method=GetRecList", { CurUserFormID: b, Condition: "[a.userformid=" + c + "]" }); return e.data && $.each(e.data, function (b, c) { a[c["colname"]] = c["userformcolid"] }), a[d] } var a = {}, b = ""; CmnMis.Frame.OnEveryUpdateInitComplete.Add(function () { if (!CmnMis.Func.CurUserIsSysAdmin) return !1; b || (b = CmnMis.Func.GetUserFormIDByDesc("用户表单字段管理")), d(CmnMis.CurUserForm.UserFormID, ""); var a = CmnMis.CurUserForm, e = $(a.GetSelector(a.Selector.EditControlPanel)), f = $("<div style='position: absolute; top: 10px; right: 10px; width: 70px; height: 30px; border-radius: 70px; border: 1px solid #ccc; line-height: 30px; text-align: center; cursor: pointer;'>排版</div>").addClass("cmn-EditLayoutBtn"), g = $("<div style='position: absolute; top: 0px; left: 0px; width:100%;height:100%; z-index:9999;cursor: move;'></div>").addClass("cmn-DragMask"); e.outerWidth() - e.width(), e.outerHeight() - e.height(), e.find(".cmn-EditLayoutBtn").length <= 0 ? e.append(f) : f = e.find(".cmn-EditLayoutBtn"), f.on("click", function () { "Edit" == $(this).attr("State") ? (CmnMis.Hint.Show(), e.find(CmnMis.UI.Control.Selector.Container).find(".cmn-DragMask").remove(), e.find(CmnMis.UI.Control.Selector.Container).css({ border: "none" }).draggable("destroy"), e.find(CmnMis.UI.Control.Selector.Container).off("mousedown"), e.resizable("destroy"), f.html("排版"), $(this).attr("State", ""), c(e, function () { CmnMis.Hint.Hide() })) : (e.find(CmnMis.UI.Control.Selector.CtlContent).css({ position: "relative" }).append(g), e.find(CmnMis.UI.Control.Selector.Container).css({ border: "1px rgb(245, 19, 234) dotted" }).draggable({ handle: ".cmn-DragMask", containment: "parent", snap: e, snapMode: "inner", grid: [5, 10], start: function () { $(this).attr("edit", "true") }, stop: function () { var c = CmnMis.UI.Control.GetControl($(this)); void 0 != c && null != c && c.ControlDom.attr("edit") && (c.ControlCfg.Layout.Left = $(this).position().left, c.ControlCfg.Layout.Top = $(this).position().top) } }), e.resizable({ handles: "n,s" }), e.find(CmnMis.UI.Control.Selector.Container).on("mousedown", function (a) { 3 == a.which || $(this).css({ position: "absolute", left: $(this).position().left, top: $(this).position().top }) }), f.html("保存排版"), $(this).attr("State", "Edit")) }) }) }();