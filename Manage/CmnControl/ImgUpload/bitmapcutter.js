window.$bcglobal={$originalSize:{width:0,top:0},$zoomValue:1,$thumbimg:null,$img:null,$cutter:null},$.extend($.fn,{f:function(a){return parseInt($(this).css(a))},loadBitmap:function(a){var b=this,c=new Image,d=b.attr("rel");c.src=d,this.onCompleted=function(){$(b).attr("src",d),$bcglobal.$originalSize={width:c.width,height:c.height},a(d)},$.browser.msie?"complete"==c.readyState?b.onCompleted():c.onreadystatechange=function(){"complete"==this.readyState&&b.onCompleted()}:c.onload=b.onCompleted},scaleBitmap:function(){return this.each(function(){var d,e,f,g,h,a=$(this),b=$bcglobal.$originalSize,c=$bcglobal.$zoomValue;a.hide(),b.width>0&&b.height>0&&a.height(b.height*c).width(b.width*c),d=a.parent(),e=a.width(),f=a.height(),g=(d.height()-f)/2,h=(d.width()-e)/2,a.css({top:g,left:h}).show(),$(".jquery-bitmapcutter-info").html(e+" : "+f)})},dragndrop:function(a){var b=$.fn.extend({limited:{lw:{min:0,max:100},th:{min:0,max:100}},handler:null,callback:function(){}},a),c={drag:function(a){var c=a.data.d,d={left:Math.min(Math.max(a.pageX+c.left,b.limited.lw.min),b.limited.lw.max),top:Math.min(Math.max(a.pageY+c.top,b.limited.th.min),b.limited.th.max),target:c.target};b.callback(d)},drop:function(){$("#cutterDiv").unbind("mousemove",c.drag).unbind("mouseup",c.drop)}};return this.each(function(){null==b.handler&&(b.handler=$(this));var a="string"==typeof b.handler?$(b.handler):b.handler;a.bind("mousedown",function(a){var b={target:$(this),left:$(this).f("left")-a.pageX,top:$(this).f("top")-a.pageY};$("#cutterDiv").bind("mousemove",{d:b},c.drag).bind("mouseup",c.drop)})})},bitmapCutter:function(settings){function izoom(a){$bcglobal.$zoomValue=a,$bcglobal.$img.scaleBitmap($bcglobal.$zoomValue),$bcglobal.$thumbimg.scaleBitmap($bcglobal.$zoomValue),scissors.createThumbnail()}function irotate(a){var b=$bcglobal.$img,c=$bcglobal.$thumbimg,e=($bcglobal.$zoomValue,b.attr("rel"));$.ajax({url:"scissors.axd",dataType:"json",data:{action:"RotateBitmap",src:e,angle:a,t:Math.random()},error:function(){alert("rotate failed!")},success:function(a){"success"==a.msg?($bcglobal.$originalSize=a.size,e+="?t="+Math.random(),b.attr("src",e).scaleBitmap(),c.attr("src",e).scaleBitmap(),scissors.createThumbnail()):alert(a.msg)}})}function imove(a){var i,j,k,b=$bcglobal.$thumbimg,c=$bcglobal.$img,e=($bcglobal.$cutter,c.width()),f=c.height(),g=c.f("left"),h=c.f("top");if(!(e<=ps.holderSize.width&&f<=ps.holderSize.height||(i={left:{min:Math.min(ps.holderSize.width-e,0),max:Math.max(ps.holderSize.width-e,0)},top:{min:Math.min(ps.holderSize.height-f,0),max:Math.max(ps.holderSize.height-f,0)}},c.is(":animated")))){switch(b.fadeOut(),j=0,k={},a){case"left":j=Math.min(i.left.max,g+ps.moveStep),k={left:j};break;case"right":j=Math.max(i.left.min,g-ps.moveStep),k={left:j};break;case"up":j=Math.min(i.top.max,h+ps.moveStep),k={top:j};break;case"down":j=Math.max(i.top.min,h-ps.moveStep),k={top:j}}c.animate(k,function(){b.fadeIn(),scissors.createThumbnail()})}}var scissors,$cl,$cr,$holder,$opts,$info,$cutter,$img,$thumbimg,$generate,$newimg,$processed,lang={zoomout:"Zoom out",zoomin:"Zoom in",original:"Original size",generate:"开始裁切!",process:"Please wait, transaction is processing......",left:"Left",right:"Right",up:"Up",down:"Down"},ps=$.fn.extend({src:"",renderTo:$(document.body),holderSize:{width:300,height:300},cutterSize:{width:70,height:70},zoomStep:.2,zoomIn:1,zoomOut:.2,rotateAngle:90,moveStep:100,onGenerated:function(){},onUpload:null,lang:lang},settings);return ps.lang=$.extend(lang,ps.lang),scissors={createThumbnail:function(){var a=$bcglobal.$thumbimg,b=$bcglobal.$img,c=$bcglobal.$cutter;a.css({left:-c.f("left")+b.f("left"),top:-c.f("top")+b.f("top")})},zoomin:function(){izoom.call(this,Math.min($bcglobal.$zoomValue+ps.zoomStep,ps.zoomIn))},zoomout:function(){izoom.call(this,Math.max($bcglobal.$zoomValue-ps.zoomStep,ps.zoomOut))},original:function(){izoom.call(this,1,1)},left:function(){imove.call(this,"left")},up:function(){imove.call(this,"up")},right:function(){imove.call(this,"right")},down:function(){imove.call(this,"down")}},ps.renderTo="string"==typeof ps.renderTo?$(ps.renderTo):ps.renderTo,$cl=$('<div class="jquery-bitmapcutter-cl" onselectstart="return false;"></div>').appendTo(ps.renderTo),$cr=$('<div class="jquery-bitmapcutter-cr"></div>').appendTo(ps.renderTo),$holder=$('<div class="jquery-bitmapcutter-holder jquery-loader" />').css(ps.holderSize).appendTo($cl),$opts=$('<div class="jquery-bitmapcutter-opts" ><div class="r1c1"><a href="javascript:void(0)" onfocus="this.blur()" class="up">&nbsp</a></div><div class="r2c1"><a href="javascript:void(0)" onfocus="this.blur()" class="zoomout">&nbsp</a><a href="javascript:void(0)" onfocus="this.blur()" class="zoomin">&nbsp</a><a href="javascript:void(0)" onfocus="this.blur()" class="left">&nbsp</a><a href="javascript:void(0)" onfocus="this.blur()" class="original">&nbsp</a><a href="javascript:void(0)" onfocus="this.blur()" class="right">&nbsp</a></div><div class="r3c1"><a href="javascript:void(0)" onfocus="this.blur()" class="down">&nbsp</a></div></div>').insertAfter($holder),$opts.css("width",ps.holderSize.width).find("div.r2c1>a:eq(0)").css("margin-left",(ps.holderSize.width-154+3)/2),$info=$('<div title="Size Of Bitmap" class="jquery-bitmapcutter-info" />').insertAfter($opts).css("width",ps.holderSize.width),$cutter=$('<div id="cutterDiv" class="jquery-bitmapcutter-cutter" >&nbsp</div>').css(ps.cutterSize).css({opacity:.4,left:(ps.holderSize.width-ps.cutterSize.width)/2,top:(ps.holderSize.height-ps.cutterSize.height)/2}).appendTo($holder),$bcglobal.$zoomValue=1,$img=$('<img alt="" rel="'+ps.src+'" />').appendTo($holder),$thumbimg=$('<img alt="" rel="'+ps.src+'" />').appendTo($('<div class="jquery-bitmapcutter-thumbnail" />').css(ps.cutterSize).appendTo($cr)),$generate=$('<a href="javascript:void(0)" class="generate" onfocus="this.blur()" >'+ps.lang.generate+"</a>").appendTo($cr),$newimg=$('<img class="jquery-bitmapcutter-newimg" alt="" src="" />').appendTo($cr).hide(),$processed=$('<div class="process">'+ps.lang.process+"</div>").hide().appendTo($cr),$img.loadBitmap(function(e){$img.scaleBitmap(),$holder.removeClass("jquery-loader");var ks={k37:"left",k38:"up",k39:"right",k40:"down",k45:"zoomout",k61:"zoomin"};$().keypress(function(e){var func,k=e.keyCode||e.which;(k>=37&&40>=k||45==k||61==k)&&(func=eval("scissors."+eval("(ks.k"+k+")")),func())}),$thumbimg.attr("src",$img.attr("src")).scaleBitmap(),$opts.find("a").each(function(){var me=$(this),c=me.attr("class");me.attr("title",eval("(ps.lang."+c+")")).bind("click",eval("(scissors."+c+")"))}),$cutter.dragndrop({limited:{lw:{min:0,max:ps.holderSize.width-ps.cutterSize.width},th:{min:0,max:ps.holderSize.height-ps.cutterSize.height}},callback:function(a){$cutter.css({left:a.left,top:a.top}),scissors.createThumbnail()}}),$generate.click(function(){var a=$(this);return a.fadeOut(),$opts.fadeOut(),$cutter.fadeOut(),$info.hide(),$processed.fadeIn(),"function"==typeof ps.onUpload?(ps.onUpload(),!1):($.ajaxFileUpload({url:"upload-class.php",secureuri:!1,data:{x1:Math.abs($thumbimg.f("left")),y1:Math.abs($thumbimg.f("top")),zoom:$bcglobal.$zoomValue,width:"100",height:"100"},fileElementId:"upload",dataType:"json",success:function(a){"1"==a.isSuccess?(ps.onGenerated(a.url),alert(ps.holderSize.width)):alert(a.message)},error:function(a){alert(a.message)}}),void 0)}),$bcglobal.$cutter=$cutter,$bcglobal.$img=$img,$bcglobal.$thumbimg=$thumbimg}),{bcglobal:$bcglobal,generate:$generate}}}),String.prototype.format=function(){var a=arguments;return this.replace(/{(d{1})}/g,function(){return a[arguments[1]]})};
